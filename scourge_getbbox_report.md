# getBBox() SCOURGE Report

**Generated:** Sun Nov 23 19:21:11 CET 2025

# ⚠️  WARNING: .getBBox() IS A SCOURGE! ⚠️

## Overview

This report lists all occurrences of the **forbidden** `.getBBox()` function in **code files only**.

**WHAT IS SCANNED:**
- Only code files: `*.js`, `*.cjs`, `*.mjs`, `*.ts`, `*.jsx`, `*.tsx`
- Only actual code lines (NOT comments!)

**WHAT IS EXCLUDED:**
- Comments: `//`, `/* */`, JSDoc, inline comments
- Config files: `*.json`, `*.yaml`, `*.yml`, `*.toml`, `package.json`, `tsconfig.json`
- Documentation: `*.md` files, `docs/` directories
- Build artifacts: `node_modules`, `dist`, `build`

---

## Why getBBox() is a SCOURGE

**Thousands of innocent SVG images were cruelly and injustly truncated because of this scourge.**

`getBBox()` is **fundamentally broken** and **must never be used**:

1. **Unreliable for complex SVG elements**
   - Ignores transforms (translate, rotate, scale, matrix)
   - Ignores filters (blur, drop-shadow, etc.)
   - Ignores stroke width, caps, joins, markers
   - Ignores viewBox clipping and coordinate systems

2. **Returns incorrect bounds for text**
   - Font-specific rendering varies across browsers
   - Ligatures, kerning, and complex scripts (Arabic, CJK, Tamil) break it
   - `textPath` and `tspan` positioning is wrong

3. **Doesn't account for visual effects**
   - Masks, clipping paths, symbols are ignored
   - Bitmap images and external resources not measured
   - Nested `<use>` elements break

**THIS ENTIRE LIBRARY EXISTS BECAUSE getBBox() IS INADEQUATE!**

---

## How to Replace getBBox() with the Correct Solution

### Step 1: Import the Library

**In Browser (HTML):**
```html
<script src="SvgVisualBBox.js"></script>
```

**In Node.js:**
```javascript
// Requires Puppeteer for headless Chrome
// See test-svg-bbox.js or export-svg-objects.cjs for Node.js examples
```

### Step 2: Replace getBBox() Calls

**WRONG (old code):**
```javascript
const bbox = element.getBBox();
console.log(bbox.x, bbox.y, bbox.width, bbox.height);
```

**CORRECT (new code):**
```javascript
// Wait for fonts to load first (important for text elements!)
await SvgVisualBBox.waitForDocumentFonts(document, 8000);

// Get accurate visual bbox using raster sampling
const bbox = await SvgVisualBBox.getSvgElementVisualBBoxTwoPassAggressive(element, {
  mode: 'unclipped',    // or 'clipped' to respect viewBox
  coarseFactor: 3,      // Pass 1 resolution multiplier
  fineFactor: 24        // Pass 2 resolution multiplier (higher = more accurate)
});

if (bbox) {
  console.log(bbox.x, bbox.y, bbox.width, bbox.height);
} else {
  console.error('Failed to measure element');
}
```

### Step 3: Understand the Options

**mode:** `'clipped'` or `'unclipped'`
- `'clipped'`: Only measure content inside viewBox/viewport (respects clipping)
- `'unclipped'`: Measure full geometry, ignoring viewBox clipping

**coarseFactor:** Pass 1 resolution multiplier (default: 3)
- Lower = faster but less accurate initial bbox
- Higher = slower but more accurate initial bbox

**fineFactor:** Pass 2 resolution multiplier (default: 24)
- Lower = faster but less precise final bbox
- Higher = slower but pixel-perfect final bbox

### Step 4: Handle Async Properly

The library uses `async/await` because it samples pixels from rendered canvas:

```javascript
// Wrap in async function or use .then()
async function measureElement(element) {
  const bbox = await SvgVisualBBox.getSvgElementVisualBBoxTwoPassAggressive(element);
  return bbox;
}
```

### Common Use Cases

**Measure single element:**
```javascript
const bbox = await SvgVisualBBox.getSvgElementVisualBBoxTwoPassAggressive(element);
```

**Measure multiple elements (union):**
```javascript
const elements = [elem1, elem2, elem3];
const unionBBox = await SvgVisualBBox.getSvgElementsUnionVisualBBox(elements);
```

**Get both clipped and unclipped bboxes:**
```javascript
const { visible, full } = await SvgVisualBBox.getSvgElementVisibleAndFullBBoxes(element);
```

**Compute viewBox expansion needed:**
```javascript
const expansion = await SvgVisualBBox.getSvgRootViewBoxExpansionForFullDrawing('svgId');
if (expansion) {
  const vb = expansion.newViewBox;
  svgRoot.setAttribute('viewBox', \`\${vb.x} \${vb.y} \${vb.width} \${vb.height}\`);
}
```

---

---

## Findings


---

## Summary

**Total occurrences of .getBBox() SCOURGE found:** 0

✅ **NO getBBox() usage found!** The codebase is clean.

**Keep it this way!** Never use `.getBBox()` - always use the SvgVisualBBox library.

---

*Report generated by scan_getbbox.sh*
